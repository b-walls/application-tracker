{% extends "base.html" %}
{% load static %}
{%block content%}
<div class="container" id="content">

</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
  const container = document.getElementById("content");

  // tiny helpers
  const badgeForStatus = s => {
    const map = { APPLIED: "primary", INTERVIEW: "warning", OFFER: "success", ACCEPTED: "success", REJECTED: "danger" };
    return map[s?.toUpperCase?.()] || "secondary";
  };
  const badgeForRemote = r => {
    const map = { REMOTE: "success", HYBRID: "info", ONSITE: "warning" };
    return map[r?.toUpperCase?.()] || "secondary";
  };
  const fmtDate = d => {
    if (!d) return "—";
    const dt = new Date(d);
    return isNaN(dt) ? d : dt.toLocaleDateString(undefined, { year: "numeric", month: "short", day: "numeric" });
  };

  function applicationCard(app){
  const title = app.job_title ?? "Untitled role";
  const posting = app.posting_details ?? {};
  const company = posting.company_details ?? {};
  const companyName = company.name ?? "Unknown Company";
  const website = company.website || null;
  const link = posting.link && posting.link !== "N/A" ? posting.link : null;
  const location = posting.location ?? null;

  return `
    <div class="card shadow-sm my-4">
      <div class="card-body">
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
          <h1 class="h3 m-0">
            ${title} <span class="text-body-secondary"> @ ${companyName}</span>
          </h1>
          <div class="d-flex gap-2">
            <span class="badge text-bg-${badgeForStatus(app.status)}">${app.status ?? "UNKNOWN"}</span>
            <span class="badge text-bg-${badgeForRemote(app.remote)}">${app.remote ?? "—"}</span>
          </div>
        </div>

        <hr class="my-3">

        <div class="row gy-2">
          <div class="col-md-6">
            <div class="d-flex align-items-center gap-2">
              <i class="fa-solid fa-calendar-days"></i>
              <span><strong>Applied:</strong> ${fmtDate(app.date)}</span>
            </div>
          </div>

          <div class="col-md-6">
            <div class="d-flex align-items-center gap-2">
              <i class="fa-solid fa-location-dot"></i>
              <span><strong>Location:</strong> ${location ?? "—"}</span>
            </div>
          </div>

          <div class="col-md-6">
            <div class="d-flex align-items-center gap-2">
              <i class="fa-solid fa-list-check"></i>
              <span><strong>Additional steps:</strong> ${
                app.additional_steps === true ? 
                  '<span class="badge text-bg-warning">Required</span>' :
                app.additional_steps === false ? 
                  '<span class="badge text-bg-success">None</span>' : '—'
              }</span>
            </div>
          </div>

          <div class="col-md-6 d-flex flex-wrap gap-2">
            ${website ? `<a class="btn btn-sm btn-outline-light" href="${website}" target="_blank">
              <i class="fa-solid fa-building-columns me-1"></i>Company Site
            </a>` : ""}

            ${link ? `<a class="btn btn-sm btn-outline-primary" href="${link}" target="_blank">
              <i class="fa-solid fa-arrow-up-right-from-square me-1"></i>Job Posting
            </a>` : ""}
          </div>
        </div>

        ${location ? `
          <div class="mt-3" style="height:300px;">
            <iframe
              src="https://www.google.com/maps?q=${encodeURIComponent(location)}&output=embed"
              width="100%" height="100%"
              style="border:0;" allowfullscreen loading="lazy">
            </iframe>
          </div>` : ""}
      </div>
    </div>
  `;
}

  function renderApplications(data){
    const apps = Array.isArray(data) ? data : [data];
    if (!apps.length) {
      container.innerHTML = `<div class="alert alert-secondary my-4">No application data.</div>`;
      return;
    }
    container.innerHTML = apps.map(applicationCard).join("");
  }

  axios.get("/api/applications/{{ pk }}")
    .then(response => renderApplications(response.data))
    .catch(err => {
      console.error(err);
      container.innerHTML = `
        <div class="alert alert-danger my-4">
          <strong>Failed to load application.</strong> Please try again later.
        </div>`;
    });
</script>
{% endblock %}